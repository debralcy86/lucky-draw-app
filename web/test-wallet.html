<!doctype html>
<html lang="en">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // minimal init (safe if run multiple times)
    try { window.Telegram?.WebApp?.expand?.(); } catch {}
  </script>
  <meta charset="utf-8" />
  <title>Wallet API Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 720px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 8px; margin: 12px 0; }
    input { flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 8px 14px; border: 0; border-radius: 8px; background: #2481cc; color: white; cursor: pointer; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow:auto; }
    small { color:#666 }
  </style>
</head>
<body>
  <h1>Wallet API Test (GET only)</h1>
  <div class="row">
    <input id="userId" value="demo-user-001" />
    <button id="btn">Fetch Wallet</button>
  </div>
  <small>Endpoint: <code>/api/data-balance?userId=... </code></small>
  <pre id="out">Click “Fetch Wallet”…</pre>

  <div>Name: <b id="tu-name">-</b></div>
  <div>Balance: <b id="tu-balance">0</b></div>
  <ul id="tu-list"></ul>
  <button id="btn-credit">Admin credit (test)</button>

  <script>
    const out = document.getElementById('out');
    const btn = document.getElementById('btn');
    const user = document.getElementById('userId');

    async function fetchWallet() {
      out.textContent = 'Loading…';
      try {
        const url = `/api/data-balance?userId=${encodeURIComponent(user.value.trim())}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const txt = await res.text();
        out.textContent = `HTTP ${res.status}\n` + txt;
      } catch (e) {
        out.textContent = 'Error: ' + (e && e.message ? e.message : e);
      }
    }

    btn.addEventListener('click', fetchWallet);
  </script>
<script type="module">
  import { whoAmI, fetchWallet, adminCredit } from '/web/_api.js';

  const nameEl = document.getElementById('tu-name');
  const balEl  = document.getElementById('tu-balance');
  const listEl = document.getElementById('tu-list');

  async function load() {
    const me = await whoAmI();
    if (!me.ok) return alert('whoAmI failed');
    const userId = me.json?.user?.id;
    if (nameEl) nameEl.textContent = me.json?.user?.username || ('User ' + userId);

    const w = await fetchWallet({ userId, limit: 10, offset: 0 });
    if (!w.ok) return alert(w.json?.error || 'wallet failed');

    if (balEl) balEl.textContent = (w.json?.wallet?.balance ?? 0);

    if (listEl) {
      listEl.innerHTML = '';
      for (const t of w.json?.txns || []) {
        const li = document.createElement('li');
        li.textContent = `${(t.created_at || '').slice(0,19)} — ${t.kind} — ${t.amount}`;
        listEl.appendChild(li);
      }
    }
  }

  // Optional: Admin credit (requires admin token/role on backend)
  document.getElementById('btn-credit')?.addEventListener('click', async () => {
    const amt = Number(prompt('Credit amount?') || 0);
    if (!amt) return;
    const note = prompt('Note (optional)') || '';
    const me = await whoAmI();
    const userId = me.json?.user?.id;
    const r = await adminCredit({ userId, amount: amt, note });
    if (!r.ok) return alert(r.json?.error || 'credit failed');
    alert('Credited');
    load();
  });

  load();
</script>
</body>
</html>

