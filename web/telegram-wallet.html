<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Telegram Wallet (Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module" src="/web/_tg.js"></script>
  <style>
    :root { --bg:#fff; --text:#111; --muted:#666; --primary:#2481cc; --card:#f6f8fa; }
    body { font-family: -apple-system, Segoe UI, Roboto, Arial; margin: 16px; color:var(--text); background:var(--bg); }
    html, body { height: 100%; }
    body { min-height: 100dvh; }
    .card { background:var(--card); border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; margin:12px 0; }
    input { flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
    button { padding:8px 14px; border:0; border-radius:8px; background:var(--primary); color:#fff; cursor:pointer; }
    .muted { color:var(--muted); font-size:13px; }
    pre { background:#00000010; padding:12px; border-radius:8px; overflow:auto; }
    h1 { margin:0 0 12px; font-size:18px; }
    .balance { font-size:22px; font-weight:700; }
  </style>
</head>
<body>
  <h1>Telegram Wallet (GET)</h1>

  <div>Name: <b id="u-name">-</b></div>
  <div>Balance: <b id="u-balance">0</b></div>
  <ul id="txn-list"></ul>
  <button id="btn-withdraw">Withdraw</button>


  <div class="row">
    <input id="userId" placeholder="Telegram user id (auto if in Telegram)" />
    <button id="btn">Fetch Wallet</button>
  </div>

  <div class="card" id="summary" style="display:none">
    <div class="muted" id="who"></div>
    <div class="balance" id="bal">RM 0.00</div>
    <div class="muted" id="txcount">0 transactions</div>
  </div>

  <div id="not-telegram" style="display:none; margin:10px 0; padding:10px; border:1px solid #fde68a; background:#fffbeb; border-radius:8px;">
    <strong>Heads up:</strong> This page is best used inside Telegram.
    <div style="margin-top:6px;">
      <a id="open-in-tg" href="#" style="text-decoration:none;">
        üëâ Open in Telegram (@LuckyDrawForUBot)
      </a>
    </div>
  </div>

  <style>
    .txns-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      background: #f6f6f7;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
    }
    .txn-line { display: flex; gap: 8px; align-items: baseline; padding: 2px 0; }
    .txn-ts { color: #666; min-width: 210px; }
    .txn-ago { color: #999; margin-left: 4px; }
    .amt-credit { color: #15803d; font-weight: 600; }
    .amt-debit  { color: #b91c1c; font-weight: 600; }
    .bal-chip   { background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:0 6px; }
    .note { color:#444; }
    #balance-amount { font-weight: 700; }
    #btn-more[disabled] { opacity: .6; cursor: not-allowed; }
  </style>
  <div id="txns-panel" style="margin-top:12px; display:none;">
    <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
      <h3 style="margin:8px 0;">Recent Transactions</h3>
      <button id="btn-refresh-txns" onclick="refreshTxns()" style="background:#6b7280">Refresh</button>
    </div>
    <div id="txns-list" class="txns-box"></div>
    <button id="btn-more" style="margin-top:8px; display:none;" onclick="loadMoreTxns()">Load more</button>
  </div>

  <div class="tag" style="margin-top:10px; font-size:12px; opacity:.7">
    v: wallet-03 ¬∑ bot: <script>document.write(window.tgBot?.botUsername || 'Unknown')</script>
  </div>

  <hr>
  <div id="admin-ui" style="border:1px solid #ccc; padding:10px; margin-top:15px;">
    <h3>Admin Controls</h3>
    <label>User ID: <input id="admin-userId" type="text" value="demo-user-001"></label><br>
    <label>Delta: <input id="admin-delta" type="number" value="10">
      <span style="display:inline-flex; gap:6px; margin-left:8px;">
        <button type="button" onclick="presetDelta(10)">+10</button>
        <button type="button" onclick="presetDelta(50)">+50</button>
        <button type="button" onclick="presetDelta(-10)">-10</button>
      </span>
    </label><br>
    <label>Note: <input id="admin-note" type="text" value="manual adjustment"></label><br>
    <button id="admin-apply" onclick="adminCreditDebit()">Apply</button>
    <p id="admin-result" style="color:green; display:none;"></p>
  </div>

  <div class="muted" style="margin:10px 0 4px">Raw API response</div>
  <pre id="out">Click ‚ÄúFetch Wallet‚Äù‚Ä¶</pre>
  <div class="muted">API base: <code id="apiBaseLabel"></code></div>
 
    <!-- ===== Withdraw (User) ===== -->
  <div id="withdraw-ui" class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 8px;">Withdraw Request</h3>
    <div class="row">
      <input id="wd-amount" type="number" min="1" step="1" placeholder="Amount (points)" />
    </div>
    <div class="row">
      <input id="wd-note" type="text" placeholder="Note (optional)" />
    </div>
    <button id="wd-submit" onclick="submitWithdraw()">Request Withdraw</button>
    <div id="wd-status" class="muted" style="margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <h4 style="margin:8px 0;">My Withdraw Requests</h4>
      <ul id="wd-requests" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;"></ul>
    </div>
  </div>

  <div id="toast" style="position:fixed; top:16px; right:16px; z-index:9999; display:none;">
    <div id="toast-inner" style="padding:10px 14px; border-radius:8px; color:#fff; box-shadow:0 6px 20px rgba(0,0,0,0.2);"></div>
  </div>

  <script>
    // Expand Telegram WebApp (like bet/admin/board/index/register)
    try { window.Telegram?.WebApp?.ready?.(); window.Telegram?.WebApp?.expand?.(); } catch {}
    console.log('TAG: wallet-03');
    const out = document.getElementById('out');
    const btn = document.getElementById('btn');
    const input = document.getElementById('userId');
    const summary = document.getElementById('summary');
    const who = document.getElementById('who');
    const bal = document.getElementById('bal');
    const txcount = document.getElementById('txcount');
    const apiBaseLabel = document.getElementById('apiBaseLabel');
    const toast = document.getElementById('toast');
    const toastInner = document.getElementById('toast-inner');
    let toastTimer = null;
    function clearToast() {
      try { clearTimeout(toastTimer); } catch {}
      toastInner.textContent = '';
      toast.style.display = 'none';
    }
    function showToast(msg, kind='info') {
      const bg = kind==='success' ? '#16a34a' : kind==='error' ? '#dc2626' : '#374151';
      toastInner.textContent = String(msg || '');
      toastInner.style.background = bg;
      toast.style.display = 'block';
      try { clearTimeout(toastTimer); } catch {}
      toastTimer = setTimeout(() => { toast.style.display = 'none'; }, 2800);
    }
    let lastFetchedUserId = '';

    // Stable production API routes
    const API_BASE = "https://lucky-draw-web.vercel.app/api/data-balance";
    const ADMIN_API = "https://lucky-draw-web.vercel.app/api/admin-credit";
    const WHOAMI_API = "https://lucky-draw-web.vercel.app/api/whoami";
    apiBaseLabel.textContent = API_BASE;

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    // Force-use Telegram raw initData (exact string, no encoding)
    const __wa = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    const __RAW_INIT = (__wa && typeof __wa.initData === 'string') ? __wa.initData : '';
    // Override any existing getInitData() so headers/body use the canonical string
    window.getInitData = function() { return __RAW_INIT; };
    if (tg && tg.colorScheme === 'dark') {
      document.documentElement.style.setProperty('--bg', '#0f0f10');
      document.documentElement.style.setProperty('--text', '#f6f7f9');
      document.documentElement.style.setProperty('--card', '#1b1c1f');
      document.documentElement.style.setProperty('--muted', '#a0a3a7');
    }

    function formatRM(n) {
      const v = Number(n || 0);
      return 'RM ' + v.toFixed(2);
    }

    function fmtAmount(a) {
      const num = Number(a || 0);
      const sign = num >= 0 ? '+' : '';
      return `${sign}${num.toFixed(2)}`;
    }
    const MYT_FMT = new Intl.DateTimeFormat('en-MY', {
      dateStyle: 'medium',
      timeStyle: 'short',
      timeZone: 'Asia/Kuala_Lumpur'
    });
    function fmtDate(iso) {
      try { return MYT_FMT.format(new Date(iso)); } catch { return iso || ''; }
    }
    function fmtAgo(iso) {
      try {
        const d = new Date(iso).getTime();
        const s = Math.max(0, Math.floor((Date.now() - d) / 1000));
        const mins = Math.floor(s/60), hrs = Math.floor(mins/60), days = Math.floor(hrs/24);
        if (days > 0) return `(${days}d ago)`;
        if (hrs  > 0) return `(${hrs}h ago)`;
        if (mins > 0) return `(${mins}m ago)`;
        return `(${s}s ago)`;
      } catch { return ''; }
    }
    const TXN_PAGE = { limit: 5, offset: 0, lastUser: '' };

    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function renderTxns(txns) {
      const panel = document.getElementById('txns-panel');
      const list = document.getElementById('txns-list');
      const btnMore = document.getElementById('btn-more');
      if (!Array.isArray(txns) || txns.length === 0) {
        panel.style.display = 'none';
        list.innerHTML = '';
        btnMore.style.display = 'none';
        return;
      }
      const lines = txns.map(t => {
        const type = String(t.type || '').toUpperCase();
        const amt  = Number(t.amount || 0);
        const cls  = amt >= 0 ? 'amt-credit' : 'amt-debit';
        const ts   = `${fmtDate(t.created_at)} <span class="txn-ago">${esc(fmtAgo(t.created_at))}</span>`;
        const note = t.note ? ` <span class="note">‚Äî ${esc(t.note)}</span>` : '';
        return `<div class="txn-line">
                  <span class="txn-ts">${ts}</span>
                  <span>${esc(type)}</span>
                  <span class="${cls}">${esc(fmtAmount(amt))}</span>
                  <span>‚Üí</span>
                  <span class="bal-chip">bal ${esc(Number(t.balance_after||0).toFixed(2))}</span>
                  ${note}
                </div>`;
      }).join('');
      list.innerHTML = lines;
      panel.style.display = '';
      if (txns.length >= TXN_PAGE.limit) {
        btnMore.style.display = '';
        btnMore.disabled = false;
        btnMore.textContent = 'Load more';
      } else {
        btnMore.style.display = '';
        btnMore.disabled = true;
        btnMore.textContent = 'No more';
      }
    }

    async function fetchWallet(userId, resetPaging=true) {
      clearToast();
      summary.style.display = 'none';
      out.textContent = 'Loading‚Ä¶';
      try {
        if (resetPaging) {
          TXN_PAGE.offset = 0;
          TXN_PAGE.lastUser = userId;
        }
        const qs = new URLSearchParams({
          userId,
          limit: String(TXN_PAGE.limit),
          offset: String(TXN_PAGE.offset),
        });
        const url = `${API_BASE}?${qs.toString()}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const txt = await res.text();
        out.textContent = `HTTP ${res.status}\n` + txt;

        try {
          const json = JSON.parse(txt);
          if (!res.ok || (json && json.ok === false)) {
            const rid = json && json.rid ? ` [rid=${json.rid}]` : '';
            showToast(`Failed to fetch wallet. ${json && json.error ? json.error : 'Error'}` + rid, 'error');
          }
          if (json && json.ok) {
            const w = json.wallet;
            const txns = Array.isArray(json.txns) ? json.txns : [];
            who.textContent = 'User: ' + (userId || '(unknown)');
            bal.textContent = formatRM(w && w.balance ? w.balance : 0);
            txcount.textContent = `${txns.length} transaction${txns.length===1?'':'s'}`;
            summary.style.display = 'block';
            renderTxns(txns);
            lastFetchedUserId = userId;
          }
        } catch(_) {}
      } catch (e) {
        out.textContent = 'Error: ' + (e && e.message ? e.message : e);
      }
    }

    async function loadMoreTxns() {
      clearToast();
      if (!TXN_PAGE.lastUser) return;
      TXN_PAGE.offset += TXN_PAGE.limit;
      const qs = new URLSearchParams({
        userId: TXN_PAGE.lastUser,
        limit: String(TXN_PAGE.limit),
        offset: String(TXN_PAGE.offset),
      });
      const res = await fetch(`${API_BASE}?${qs.toString()}`);
      const data = await res.json();
      if (!res.ok || (data && data.ok === false)) {
        const rid = data && data.rid ? ` [rid=${data.rid}]` : '';
        showToast(`Failed to load more. ${data && data.error ? data.error : 'Error'}` + rid, 'error');
        return;
      }
      const container = document.getElementById('txns-list');
      const extra = (data?.txns || []).map(t => {
        const type = String(t.type || '').toUpperCase();
        const amt  = Number(t.amount || 0);
        const cls  = amt >= 0 ? 'amt-credit' : 'amt-debit';
        const ts   = `${fmtDate(t.created_at)} <span class="txn-ago">${esc(fmtAgo(t.created_at))}</span>`;
        const note = t.note ? ` <span class="note">‚Äî ${esc(t.note)}</span>` : '';
        return `<div class="txn-line">
                  <span class="txn-ts">${ts}</span>
                  <span>${esc(type)}</span>
                  <span class="${cls}">${esc(fmtAmount(amt))}</span>
                  <span>‚Üí</span>
                  <span class="bal-chip">bal ${esc(Number(t.balance_after||0).toFixed(2))}</span>
                  ${note}
                </div>`;
      }).join('');
      container.insertAdjacentHTML('beforeend', extra);
      const btn = document.getElementById('btn-more');
      if ((data?.txns?.length || 0) >= TXN_PAGE.limit) {
        btn.disabled = false; btn.textContent = 'Load more';
      } else {
        btn.disabled = true; btn.textContent = 'No more';
      }
    }

    btn.addEventListener('click', () => {
      const id = (input.value || '').trim();
      if (!id) { out.textContent = 'Please enter a user id'; return; }
      fetchWallet(id);
    });

    function getTelegramUserId() {
      try {
        return String(window.Telegram?.WebApp?.initDataUnsafe?.user?.id || '');
      } catch { return ''; }
    }

    // getInitData() provided by /web/_tg.js
    function getTelegramUserIdUnsafe() {
      try { return String(window.Telegram?.WebApp?.initDataUnsafe?.user?.id || ''); } catch { return ''; }
    }
    function isInTelegram() {
      return !!getInitData();
    }

    // Admin action: credit/debit balance (server verifies Telegram initData)
    async function adminCreditDebit() {
      clearToast();
      const userId = (document.getElementById('admin-userId').value || '').trim();
      const delta = Number(document.getElementById('admin-delta').value || 0);
      const note = (document.getElementById('admin-note').value || '').trim();
      const el = document.getElementById('admin-result');
      const applyBtn = document.getElementById('admin-apply');
      el.style.color = 'inherit';
      el.textContent = '';
      applyBtn.disabled = true;
      const originalText = applyBtn.textContent;
      applyBtn.textContent = 'Applying‚Ä¶';
      try {
        const initData = getInitData();
        const headers = { 'Content-Type': 'application/json', 'Authorization': `tma ${initData || ''}` };
        const res = await fetch(ADMIN_API, {
          method: 'POST',
          headers,
          body: JSON.stringify({ initData, userId, delta, note })
        });
        const data = await res.json();
        if (data && data.ok) {
          showToast('Balance updated', 'success');
          await fetchWallet(userId, true); // refresh and reset paging
        } else {
          const rid = data && data.rid ? ` [rid=${data.rid}]` : '';
          const msg = (data && (data.error || data.details)) || 'Request failed';
          showToast(msg + rid, 'error');
        }
      } catch (err) {
        showToast('Error: ' + (err && err.message ? err.message : err), 'error');
      }
      applyBtn.disabled = false;
      applyBtn.textContent = originalText;
    }

    async function initWhoAmI() {
      const initData = getInitData();
      const adminBlock = document.getElementById('admin-ui');
      try {
        const res = await fetch(WHOAMI_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `tma ${initData || ''}` },
          body: JSON.stringify({ initData })
        });
        const data = await res.json();
        if (data?.ok && data?.isAdmin) {
          adminBlock.style.display = '';
        } else {
          adminBlock.style.display = 'none';
        }
      } catch {
        adminBlock.style.display = 'none';
      }
    }

    (async function bootstrap(){
      const inTG = isInTelegram();
      // Update the "Open in Telegram" link via shared helper in /web/_tg.js
      const openLink = document.getElementById('open-in-tg');
      if (openLink && window.tgBot && typeof window.tgBot.tgBotLink === 'function') {
        openLink.href = window.tgBot.tgBotLink('startapp', 'wallet');
      }
      if (!inTG) {
        const banner = document.getElementById('not-telegram');
        if (banner) banner.style.display = '';
        const adminBlock = document.getElementById('admin-ui');
        if (adminBlock) adminBlock.style.display = 'none';
      } else {
        await initWhoAmI();
      }
      const tgUser = inTG ? getTelegramUserIdUnsafe() : '';
      const adminInput = document.getElementById('admin-userId')?.value || '';
      const defaultUser = tgUser || adminInput || 'demo-user-001';
      if (tgUser) {
        const idInput = document.getElementById('admin-userId');
        if (idInput) idInput.value = tgUser;
      }
      input.value = defaultUser;
      await fetchWallet(defaultUser, true);
    })();

    // --- Withdraw: POST /api/withdraw-create ---
    async function submitWithdraw() {
      clearToast();
      const statusEl = document.getElementById('wd-status');
      const amtEl = document.getElementById('wd-amount');
      const noteEl = document.getElementById('wd-note');
      const amount = Number(amtEl.value || 0);
      const note = String(noteEl.value || '').trim();
      statusEl.textContent = '';

      const initData = getInitData();
      if (!initData) {
        statusEl.textContent = 'Open this page inside Telegram to request a withdraw.';
        showToast('Not in Telegram WebApp', 'error');
        return;
      }
      if (!Number.isFinite(amount) || amount <= 0) {
        statusEl.textContent = 'Enter a valid amount (> 0).';
        return;
      }

      const btn = document.getElementById('wd-submit');
      const orig = btn.textContent;
      btn.disabled = true; btn.textContent = 'Submitting‚Ä¶';
      try {
        const res = await fetch('/api/withdraw-create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `tma ${initData || ''}` },
          body: JSON.stringify({ initData, amount, note })
        });
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data?.ok) {
          showToast('Withdraw requested', 'success');
          statusEl.textContent = `Request ID: ${data.request?.id || '‚Äî'} ‚Ä¢ Status: ${data.request?.status || 'pending'}`;
          if (lastFetchedUserId) { await fetchWallet(lastFetchedUserId, true); }
          amtEl.value = ''; noteEl.value = '';
        } else {
          const msg = data?.error || 'Request failed';
          statusEl.textContent = `‚ùå ${msg}${data?.rid ? ' [rid=' + data.rid + ']' : ''}`;
          showToast(msg, 'error');
        }
      } catch (e) {
        statusEl.textContent = 'Network error.';
        showToast('Network error', 'error');
      } finally {
        btn.disabled = false; btn.textContent = orig;
      }
    }
  </script>
  
  <!-- ---- TEMP: Telegram initData debug panel (remove after testing) ---- -->
  <div id="tg-debug" style="display:none;margin:12px 0;padding:8px;border:1px dashed #888;border-radius:8px;background:#111;color:#ddd;">
    <div style="font-weight:600;margin-bottom:6px;">Telegram initData (tap to copy)</div>
    <textarea id="tg-initdata" readonly
      style="width:100%;height:88px;font-size:10px;line-height:1.2;background:#000;color:#9fe;border:1px solid #333;border-radius:6px;padding:6px;"></textarea>
    <button id="tg-copy" style="margin-top:8px;padding:6px 10px;border-radius:6px;border:0;background:#2b74ff;color:#fff;">
      Copy initData
    </button>
    <div id="tg-copy-status" style="font-size:12px;margin-top:6px;opacity:.8;"></div>
  </div>

  <script>
  (function () {
    const wa = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (!wa) return;                        // not inside Telegram ‚Üí keep hidden

    const initData = wa.initData || "";     // signed string from Telegram
    const box = document.getElementById('tg-debug');
    const ta  = document.getElementById('tg-initdata');
    const btn = document.getElementById('tg-copy');
    const msg = document.getElementById('tg-copy-status');

    ta.value = initData;
    box.style.display = 'block';

    btn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(ta.value);
        msg.textContent = 'Copied to clipboard.';
      } catch (e) {
        // fallback: select text so user can copy manually
        ta.focus(); ta.select();
        msg.textContent = 'Select-all done. Press ‚åò/Ctrl+C to copy.';
      }
    });
  })();
  </script>
  <!-- ---- END TEMP ---- -->

  <!-- Get Open Draw helper -->
  <div style="margin:8px 0;">
    <button id="btn-open-draw"
            style="padding:8px 10px;border:0;border-radius:8px;background:#444;color:#fff;">
      Use Open Draw
    </button>
    <span id="open-draw-hint" style="margin-left:8px;font-size:12px;opacity:.85"></span>
  </div>

  <script>
  (function () {
    const $ = (id) => document.getElementById(id);
    const btn = $('btn-open-draw');
    const hint = $('open-draw-hint');
    const drawEl = $('bet-draw-id');

    async function fetchOpenDraw() {
      hint.textContent = '';
      btn.disabled = true; btn.textContent = 'Checking‚Ä¶';
      const bases = [
        // try same-origin first
        `${location.origin}/api/open-draw`,
        // then stable production domain
        'https://lucky-draw-web.vercel.app/api/open-draw',
      ];
      let lastErr = '';
      for (const url of bases) {
        try {
          const r = await fetch(url, { mode: 'cors', credentials: 'omit' });
          const txt = await r.text();
          let j = {};
          try { j = JSON.parse(txt); } catch {}
          if (r.ok && j?.ok) {
            if (j?.open?.id) {
              drawEl.value = j.open.id;
              hint.textContent = `Open draw: ${j.open.code || j.open.id}`;
            } else {
              const rid = j?.rid ? ` (rid: ${j.rid})` : '';
              hint.textContent = `No open draw found${rid}`;
            }
            return; // success path
          }
          lastErr = `HTTP ${r.status}${j?.rid ? ` [rid=${j.rid}]` : ''}`;
        } catch (e) {
          lastErr = 'Network error';
        }
      }
      hint.textContent = `Open draw fetch failed: ${lastErr}`;
      btn.disabled = false; btn.textContent = 'Use Open Draw';
    }

    btn.addEventListener('click', fetchOpenDraw);
  })();
  </script>

  <!-- ===== Place Bet (Mini) ===== -->
  <section id="bet-panel" style="margin:16px 0;padding:12px;border:1px solid #333;border-radius:10px;background:#0b0b0b;color:#eee">
    <div style="font-weight:700;margin-bottom:8px;">Place Bet</div>

    <label style="display:block;margin:6px 0 2px">Draw ID</label>
    <input id="bet-draw-id" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
           style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#ddd"/>

    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label style="display:block;margin:6px 0 2px">Figure (1..36)</label>
        <input id="bet-figure" type="number" min="1" max="36" step="1" value="7"
               style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#ddd"/>
      </div>
      <div style="flex:1">
        <label style="display:block;margin:6px 0 2px">Amount</label>
        <input id="bet-amount" type="number" min="1" step="1" value="10"
               style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#ddd"/>
      </div>
    </div>

    <button id="bet-submit"
            style="margin-top:12px;padding:10px 12px;border:0;border-radius:10px;background:#2b74ff;color:#fff;font-weight:700">
      Place Bet
    </button>

    <div id="bet-status" style="margin-top:8px;font-size:12px;opacity:.9"></div>
  </section>

  <script>
  (function () {
    const $ = (id) => document.getElementById(id);
    const btn = $('bet-submit');
    const msg = $('bet-status');
    const drawEl = $('bet-draw-id');
    const figEl  = $('bet-figure');
    const amtEl  = $('bet-amount');

    // Optional: if your page already knows the default wallet user / open draw, you can prefill drawEl.value here.

    async function placeBet() {
      // Clear any existing toast/status on action (if you have clearToast, call it)
      if (typeof clearToast === 'function') clearToast();
      msg.textContent = '';

      const initData = getInitData();
      if (!initData) {
        msg.textContent = 'Open this page inside Telegram to place a bet.';
        return;
      }

      const drawId = String(drawEl.value || '').trim();
      const figure = Number(figEl.value);
      const amount = Number(amtEl.value);

      if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(drawId)) {
        msg.textContent = 'Please enter a valid Draw ID (UUID).';
        return;
      }
      if (!Number.isInteger(figure) || figure < 1 || figure > 36) {
        msg.textContent = 'Figure must be an integer 1..36.';
        return;
      }
      if (!Number.isFinite(amount) || amount <= 0) {
        msg.textContent = 'Amount must be > 0.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Placing‚Ä¶';

      try {
        const resp = await fetch('/api/bet', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'Authorization': `tma ${initData || ''}`},
          body: JSON.stringify({
            initData,  // signed Telegram payload
            drawId, figure, amount
          })
        });
        const data = await resp.json().catch(() => ({}));

        if (data?.ok) {
          msg.textContent = `Bet placed ‚úÖ  New balance: ${data.balance_after}`;
          // If your page has fetchWallet(userId, reset) wired, refresh the wallet/txns:
          if (typeof fetchWallet === 'function') {
            // Use current userId in your UI if available, otherwise skip
            const uidEl = document.getElementById('user-id') || document.getElementById('admin-user-id');
            const u = uidEl ? uidEl.value : null;
            if (u) await fetchWallet(u, true);
          }
        } else {
          const rid = data?.rid ? ` (rid: ${data.rid})` : '';
          msg.textContent = `Bet failed ‚ùå ${data?.error || ''}${rid}`;
          if (typeof showToast === 'function') showToast(`Bet failed: ${data?.error || 'unknown'}${rid}`, true);
        }
      } catch (e) {
        msg.textContent = 'Network error.';
        if (typeof showToast === 'function') showToast('Network error while placing bet', true);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Place Bet';
      }
    }

    btn.addEventListener('click', placeBet);
  })();
  </script>

  <script>
    // Ensure Telegram WebApp uses full height (safety net)
    (function() {
      function expandIfReady() {
        try {
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
          }
        } catch (e) {}
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', expandIfReady);
      } else {
        expandIfReady();
      }
    })();
  </script>
<script type="module">
  import { go } from '/web/_nav.js';
  document.querySelectorAll('[data-link]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      go(a.getAttribute('data-link'));
    });
  });
</script>

<!-- Optional quick links:
<button data-link="/web/bet.html">Bet</button>
<button data-link="/web/board.html">Board</button> -->
<script type="module">
  import { requireTelegramBanner } from '/web/_guard.js';
  requireTelegramBanner();
</script>
<script type="module">
  import { whoAmI, fetchWallet, createWithdraw, listMyWithdrawRequests } from '/web/_api.js';
  import { toast, spinner } from '/web/_ui.js';

  const elName = document.getElementById('u-name');
  const elBal  = document.getElementById('u-balance');
  const elList = document.getElementById('txn-list');
  const elWdqs = document.getElementById('wd-requests');   // <ul> for my withdraw requests
  const btnW   = document.getElementById('btn-withdraw');

  async function loadWallet() {
    const me = await whoAmI();
    if (!me.ok) throw new Error('whoAmI failed');
    const userId = me.json?.user?.id;
    if (elName) elName.textContent = me.json?.user?.username || ('User ' + userId);

    const w = await fetchWallet({ userId, limit: 20, offset: 0 });
    if (!w.ok) throw new Error(w.json?.error || 'wallet failed');

    if (elBal) elBal.textContent = (w.json?.wallet?.balance ?? 0);

    if (elList) {
      elList.innerHTML = '';
      for (const t of w.json?.txns || []) {
        const li = document.createElement('li');
        li.textContent = `${(t.created_at||'').slice(0,19)} ‚Äî ${t.kind} ‚Äî ${t.amount}`;
        elList.appendChild(li);
      }
    }
  }

  async function loadMyWithdraws() {
    if (!elWdqs) return;
    elWdqs.innerHTML = '<li>Loading‚Ä¶</li>';
    const r = await listMyWithdrawRequests();
    if (!r.ok) { elWdqs.innerHTML = `<li>${r.json?.error || 'Failed to load'}</li>`; return; }
    const rows = r.json?.items || r.json || [];
    if (!rows.length) { elWdqs.innerHTML = '<li>No withdraw requests</li>'; return; }
    elWdqs.innerHTML = '';
    for (const x of rows) {
      const li = document.createElement('li');
      const ts = (x.created_at || x.createdAt || '').slice(0,19);
      li.textContent = `#${x.id} ‚Äî ${ts} ‚Äî ${x.amount} ‚Äî ${x.status || 'pending'}`;
      elWdqs.appendChild(li);
    }
  }

  async function load() {
    spinner(true);
    try {
      await loadWallet();
      await loadMyWithdraws();
    } catch (e) {
      toast(e.message || 'Load error');
    } finally {
      spinner(false);
    }
  }

  btnW?.addEventListener('click', async () => {
    const amount = Number(prompt('Withdraw amount?') || 0);
    if (!amount) return;
    const note = prompt('Note (optional)') || '';
    spinner(true);
    try {
      const r = await createWithdraw({ amount, note });
      if (!r.ok) throw new Error(r.json?.error || 'Withdraw failed');
      toast('Withdraw submitted');
      await load();
    } catch (e) {
      toast(e.message || 'Withdraw error');
    } finally {
      spinner(false);
    }
  });

  load();
</script>
</script>
<script>
(function initLogger() {
  const wa = window.Telegram && window.Telegram.WebApp;
  if (!wa) return;
  const raw = wa.initData || '';
  console.group('%c[TMA DEBUG] Telegram initData','color:#2b74ff;font-weight:bold');
  console.log('RAW INITDATA:', raw);
  console.log('LENGTH:', raw.length);
  console.groupEnd();

  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:8px;left:8px;z-index:9999;background:#111;color:#0ff;font-size:11px;padding:4px 8px;border-radius:6px;';
  el.textContent = 'initData len: ' + raw.length;
  document.body.appendChild(el);
})();
</script>
</body>
</html>

