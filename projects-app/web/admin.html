<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
/>
  <title>Admin Dashboard — Lucky Draw</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0b0f16; --fg:#e8eef8; --muted:#94a3b8; --card:#121826; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#1f2937; }
    body { margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); }
    html, body { height: 100%; }
    main { min-height: 100dvh; }
    header { padding:16px 20px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; }
    h1 { font-size:18px; margin:0; }
    .tabs { display:flex; gap:8px; }
    .tab { padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:var(--card); cursor:pointer; }
    .tab.active { outline:2px solid var(--accent); }
    main { padding:16px 20px; }
    .grid { display:grid; gap:12px; }
    .grid.kpi { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .label { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing: .08em; }
    .value { font-size:20px; margin-top:6px; }
    .row { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
    .row > * { flex:1 1 220px; }
    input, select, button, textarea {
      background:#0e1420; color:var(--fg); border:1px solid var(--line); border-radius:10px; padding:10px 12px;
    }
    button.primary { background:var(--accent); border-color:transparent; color:#08110a; font-weight:600; cursor:pointer; }
    button.warn { background:var(--warn); border-color:transparent; color:#111; font-weight:600; cursor:pointer; }
    button.error { background:var(--err); border-color:transparent; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:14px; }
    .sublabel { color:var(--muted); font-size:12px; }
    .toast { position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--line); padding:12px 14px; border-radius:12px; display:none; }
    .toast.show { display:block; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .board { display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; }
    .cell { border:1px solid var(--line); background:#0e1420; border-radius:10px; padding:10px; text-align:center; }
    .pulse { animation: pulse 500ms ease-out; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34,197,94,.4) } 100% { box-shadow: 0 0 0 12px rgba(34,197,94,0) } }
    .muted { color:var(--muted); }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mt8 { margin-top:8px; }
    .mt12 { margin-top:12px; }
    .mt16 { margin-top:16px; }
    .mt20 { margin-top:20px; }
    .right { text-align:right; }
    .chip { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#0e1420; font-size:12px; }
    .ok { color:var(--accent); }
    .bad { color:var(--err); }
    .warnText { color:var(--warn); }
    pre { background:#0e1420; border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto; }
  </style>
</head>
<body>

  <div id="admin-gate">Checking…</div>
  <div id="admin-body">
    <div style="margin:12px 20px;">
      <button id="btn-open-draw">Open Draw</button>
    </div>
    <header>
    <h1>Admin Dashboard — Lucky Draw</h1>
    <div class="tabs">
      <button class="tab active" data-tab="overview">Overview</button>
      <button class="tab" data-tab="draws">Draws</button>
      <button class="tab" data-tab="txns">Transactions</button>
      <button class="tab" data-tab="withdraws">Withdraws</button>
      <button class="tab" data-tab="deposits">Deposits</button>
      <button class="tab" data-tab="reports">Reports</button>
    </div>
    <div style="margin-left:auto" id="adminBadge" class="chip">Checking admin…</div>
    <span id="rid" class="chip" title="request id" style="margin-left:8px"></span>
  </header>

  <main>
    <div id="tg-warning" style="display:none;padding:10px;border-radius:10px;margin:12px 0;background:#111827;color:#e6edf3">⚠️ Open this page <b>from Telegram</b> (via your bot’s WebApp button). No Telegram initData was detected.</div>
    <div id="tgDiag" style="position:sticky;top:0;z-index:9999;padding:8px;margin:8px 0;border-radius:6px;background:#111827;color:#e6edf3;font-size:12px;white-space:pre-wrap;box-shadow:0 2px 8px rgba(0,0,0,.25)">Awaiting Telegram SDK…</div>
    <pre id="whoamiDebug" class="mono" style="display:none;background:#111827;color:#e6edf3;padding:8px;border-radius:8px;max-height:200px;overflow:auto;margin:12px 0"></pre>
    <!-- OVERVIEW -->
    <section id="panel-overview">
      <div class="grid kpi">
        <div class="card">
          <div class="label">Users</div>
          <div class="value" id="kpiUsers">—</div>
        </div>
        <div class="card">
          <div class="label">Total Wallet Balance</div>
          <div class="value" id="kpiBal">—</div>
        </div>
        <div class="card">
          <div class="label">Open Draw</div>
          <div class="value" id="kpiDraw">—</div>
          <div class="sublabel" id="kpiDrawMeta"></div>
        </div>
        <div class="card">
          <div class="label">Pending Withdraws</div>
          <div class="value" id="k-wd-pending">0</div>
        </div>
        <div class="card">
          <div class="label">Approved Today (RM)</div>
          <div class="value" id="k-wd-approved">0.00</div>
        </div>
      </div>
      <div class="mt12">
        <button id="btnGoPendingWds" class="primary">View pending withdraws</button>
      </div>

      <div class="card mt16">
        <div class="flex">
          <div class="label">Live Board (group)</div>
          <select id="ovGroup">
            <option value="A">A (00:00 MYT)</option>
            <option value="B">B (06:00 MYT)</option>
            <option value="C">C (12:00 MYT)</option>
            <option value="D">D (18:00 MYT)</option>
          </select>
          <span class="chip" id="ovBoardMeta">—</span>
        </div>
        <div id="boardWrap" class="mt12">
          <div id="boardGrid" class="board"></div>
        </div>
      </div>
    
    <div class="card mt16">
      <div class="label">Admin Metrics</div>
      <div style="margin-top:8px;">
        <button id="btn-refresh-metrics" class="primary" type="button">Refresh Metrics</button>
      </div>
      <div id="metrics" class="mt12" style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; white-space:pre-wrap; background:#0e1420; border:1px solid var(--line); border-radius:12px; padding:12px;">Loading…</div>
    </div>

    <!-- DRAWS -->
    <section id="panel-draws" style="display:none">
      <div class="card">
        <div class="label">Current Open Draw</div>
        <div class="value" id="drawNow">—</div>
        <div class="sublabel" id="drawNowMeta"></div>
      </div>

      <div class="card mt16">
        <div class="label">Controls</div>
        <div class="row mt8">
          <div>
            <label class="sublabel">Group</label>
            <select id="ctlGroup">
              <option>A</option><option>B</option><option>C</option><option>D</option>
            </select>
          </div>
          <div>
            <label class="sublabel">Force Winning (1..36, optional)</label>
            <input id="ctlForce" type="number" min="1" max="36" placeholder="e.g. 7" />
          </div>
          <div class="flex" style="gap:10px;">
            <button id="btnCloseNow" class="warn">Close Now</button>
            <button id="btnExecuteNow" class="primary">Execute Now</button>
            <button id="btnSeedNext" class="">Seed Next Slot</button>
          </div>
        </div>
        <div class="mt12">
          <div class="sublabel">Response</div>
          <pre id="ctlResult" class="mono">—</pre>
        </div>
      </div>
    </section>

    <!-- TXNS -->
    <section id="panel-txns" style="display:none">
      <div class="card">
        <div class="label">Filter</div>
        <div class="row mt8">
          <div>
            <label class="sublabel">Type</label>
            <select id="fType">
              <option value="">Any</option>
              <option value="credit">Credit</option>
              <option value="debit">Debit</option>
            </select>
          </div>
          <div>
            <label class="sublabel">Text contains</label>
            <input id="fText" type="text" placeholder="note / user mask…" />
          </div>
          <div style="display:flex; gap:10px; align-items:flex-end;">
            <button id="btnReloadTxns" class="primary">Reload</button>
          </div>
        </div>
        <div class="mt12">
          <table id="txTable">
            <thead><tr>
              <th>When (MYT)</th><th>User</th><th>Type</th><th class="right">Amount</th><th class="right">Bal After</th><th>Note</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt12 flex">
          <button id="btnMoreTxns">Load more</button>
          <span id="txnsHint" class="muted">Showing latest 50</span>
        </div>
      </div>
    </section>

    <!-- WITHDRAWS (read-only list) -->
    <section id="panel-withdraws" style="display:none">
      <div class="card">
        <div class="label">Filter</div>
        <div class="row mt8">
          <div>
            <label class="sublabel">Status</label>
            <select id="wdStatus">
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="">Any</option>
            </select>
          </div>
          <div style="display:flex; gap:10px; align-items:flex-end;">
            <button id="btnReloadWds" class="primary">Reload</button>
          </div>
        </div>
        <div class="mt12">
          <table id="wdTable">
            <thead><tr>
              <th>When (MYT)</th><th>User</th><th class="right">Amount</th><th>Note</th><th>Status</th><th>Actions</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt12 flex">
          <button id="btnMoreWds">Load more</button>
          <span id="wdsHint" class="muted">Showing latest</span>
        </div>
      </div>
    </section>

  <!-- DEPOSITS -->
    <section id="panel-deposits" style="display:none">
      <div class="card">
        <div class="label">Filter</div>
        <div class="row mt8">
          <div>
            <label class="sublabel">Status</label>
            <select id="depStatus">
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="">Any</option>
            </select>
          </div>
          <div style="display:flex; gap:10px; align-items:flex-end;">
        <button id="btnReloadDeps" class="primary">Reload</button>
      </div>
    </div>
    <div class="mt12">
      <table id="depTable">
        <thead><tr>
          <th>When (MYT)</th><th>User</th><th class="right">Amount</th><th>Note</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="mt12 flex">
      <button id="btnMoreDeps">Load more</button>
      <span id="depsHint" class="muted">Showing latest</span>
    </div>
  </div>
</section>
<!-- REPORTS -->
<section id="panel-reports" style="display:none">
  <div class="card">
    <div class="label">Select Table</div>
    <div class="row mt8">
      <select id="repTable">
        <option value="withdraw_requests">Withdraw Requests</option>
        <option value="deposit_requests">Deposit Requests</option>
        <option value="wallet_txns">Wallet Transactions</option>
        <option value="profiles">Profiles</option>
      </select>
      <button id="btnLoadReport" class="primary">Load</button>
    </div>
    <div class="mt12" id="repOutput">Select a table to view report</div>
  </div>
</section>
  </main>

  <div id="toast" class="toast mono"></div>

  <script type="module">
    import { getInitData, authHeader } from "/web/_tg.js?v=2";
    console.log('TAG: admin-07');
    try { window.Telegram?.WebApp?.ready?.(); window.Telegram?.WebApp?.expand?.(); } catch {}
    // Local fallback: show a banner if the page isn't opened inside Telegram
    function showNoTelegramBanner(id = "tg-warning") {
      const el = document.getElementById(id);
      if (!el) return;
      const inTG = !!(window?.Telegram?.WebApp?.initData);
      el.style.display = inTG ? "none" : "block";
    }

    // --- Telegram diagnostics info ---
    (async () => {
      const box = document.getElementById('tgDiag');
      try {
        const hasTG = !!window.Telegram;
        const hasWebApp = !!window.Telegram?.WebApp;
        const raw = window.Telegram?.WebApp?.initData || '';
        const rawLen = raw.length;
        const viaHelper = await getInitData({ retries: 10, delayMs: 150 });
        const viaLen = (viaHelper || '').length;
        const info = {
          host: location.host,
          href: location.href,
          ua: navigator.userAgent,
          hasTelegram: hasTG,
          hasWebApp: hasWebApp,
          initDataLen: rawLen,
          helperLen: viaLen,
          initDataHead: raw.slice(0, 80)
        };
        box.textContent = JSON.stringify(info, null, 2);
      } catch (e) {
        box.textContent = 'Diag error: ' + (e?.message || e);
      }
    })();
    // ---------- Config ----------
    const API = {
      whoami: "/api/whoami",
      metrics: "/api/admin-metrics",
      txns: "/api/admin-txns",
      openDraw: "/api/open-draw",
      board: "/api/board",
      sse: "/api/board-stream",
      exec: "/api/admin-draw-exec",
      withdraws: "/api/admin-withdraws",
      withdrawUpdate: "/api/admin-withdraw-update"
    };
    const CRON_KEY = "test-12345-xyz"; // uses strict header-based auth (your scheduler setting)

    const RID = Math.random().toString(36).slice(2);
    function setRID() { const el = document.getElementById('rid'); if (el) el.textContent = `rid:${RID}`; }

    const MYT = new Intl.DateTimeFormat('en-MY', { dateStyle: 'medium', timeStyle: 'short', timeZone: 'Asia/Kuala_Lumpur' });

    // ---------- UI Helpers ----------
    const $ = s => document.querySelector(s);
    const $all = s => Array.from(document.querySelectorAll(s));
    const toast = (msg, kind="") => {
      const t = $("#toast"); t.textContent = msg; t.className = "toast mono show"; if (kind) t.classList.add(kind);
      setTimeout(()=>t.classList.remove("show"), 3000);
    };
    function setTableLoading(tbodyId, text = 'Loading…') {
      const tb = document.querySelector(tbodyId);
      if (!tb) return;
      tb.innerHTML = `<tr><td class="muted" colspan="999">${text}</td></tr>`;
    }
    function setTableEmpty(tbodyId, text = 'No records') {
      const tb = document.querySelector(tbodyId);
      if (!tb) return;
      tb.innerHTML = `<tr><td class="muted" colspan="999">${text}</td></tr>`;
    }
    let DEP_LOADED = false;
    let REP_LOADED = false;
    const setTab = id => {
      $all(".tab").forEach(b => b.classList.toggle("active", b.dataset.tab === id));
      $("#panel-overview").style.display = id==="overview"?"block":"none";
      $("#panel-draws").style.display = id==="draws"?"block":"none";
      $("#panel-txns").style.display = id==="txns"?"block":"none";
      $("#panel-withdraws").style.display = id==="withdraws"?"block":"none";
      $("#panel-deposits").style.display = id==="deposits"?"block":"none";
      $("#panel-reports").style.display = id==="reports"?"block":"none";
    };  
    $all(".tab").forEach(b => b.addEventListener("click", () => {
      const tab = b.dataset.tab;
      setTab(tab);
      if (tab === 'deposits' && !DEP_LOADED) {
        DEP_LOADED = true;
        if (typeof loadDeposits === 'function') loadDeposits(true);
      }
      if (tab === 'reports' && !REP_LOADED) {
        REP_LOADED = true;
        if (typeof loadReport === 'function') loadReport();
      }
    }));

    // ---------- Admin Gate ----------
    let ADMIN = false;
    let INITDATA = "";
    // getInitData() provided by /web/_tg.js
    async function postJSON(url, body, extraHeaders = {}, opts = {}) {
      const { timeoutMs = 8000 } = opts;
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const baseHeaders = { "Content-Type": "application/json" };
        const auth = INITDATA ? authHeader(INITDATA) : {};
        const res = await fetch(url, {
          method: "POST",
          headers: { ...baseHeaders, ...auth, ...extraHeaders },
          body: JSON.stringify(body),
          signal: ctrl.signal
        });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          const err = new Error("Request failed");
          err.status = res.status; err.data = data; throw err;
        }
        return data;
      } finally {
        clearTimeout(to);
      }
    }

    async function ensureAdmin() {
      const badge = document.getElementById("adminBadge");
      const dbg = document.getElementById('whoamiDebug');
      if (dbg) { dbg.style.display = 'block'; dbg.textContent = 'Calling /api/whoami…'; }
      let init = "";
      try {
        // Try helper first, then raw Telegram object
        try { init = await getInitData({ retries: 6, delayMs: 150 }); } catch {}
        if (!init && window?.Telegram?.WebApp?.initData) {
          init = window.Telegram.WebApp.initData;
        }

        // Show banner if still missing
        if (!init) {
          showNoTelegramBanner && showNoTelegramBanner("tg-warning");
          badge.textContent = "Access denied";
          badge.classList.add("bad");
          return false;
        }

        // Save globally for subsequent calls
        INITDATA = init;
        console.log("DEBUG initData", { len: INITDATA.length, head: INITDATA.slice(0, 60), rid: RID });

        // Call whoami with timeout (no debug header echo of initData)
        const r = await postJSON(
          API.whoami,
          { initData: INITDATA, rid: RID },
          { 'X-Debug-RID': RID, 'X-Request-Host': location.host },
          { timeoutMs: 8000 }
        );
        if (dbg) dbg.textContent = JSON.stringify(r, null, 2);

        if (r && r.ok && r.isAdmin) {
          ADMIN = true;
          badge.textContent = `Admin ${r.userId}`;
          badge.classList.add("ok");
          return true;
        }

        // Not admin
        badge.textContent = "Access denied";
        badge.classList.add("bad");
        const pre = document.getElementById('ctlResult');
        if (pre) pre.textContent = JSON.stringify(r || { error: 'not_admin' }, null, 2);
        return false;
      } catch (e) {
        // Network / verify / other error
        badge.textContent = "Access denied";
        badge.classList.add("bad");
        const pre = document.getElementById('ctlResult');
        if (pre) {
          pre.textContent = JSON.stringify({
            error: e?.message || String(e),
            status: e?.status || 0,
            data: e?.data || null,
            rid: RID,
            initData_len: INITDATA ? INITDATA.length : 0,
            initData_head: INITDATA ? INITDATA.slice(0,40) : ''
          }, null, 2);
        }
        if (dbg) dbg.textContent = JSON.stringify({
          error: e?.message || String(e),
          status: e?.status || 0,
          data: e?.data || null,
          rid: RID,
          initData_len: INITDATA ? INITDATA.length : 0,
          initData_head: INITDATA ? INITDATA.slice(0,40) : ''
        }, null, 2);
        return false;
      }
    }

    // ---------- Overview KPIs ----------
    async function loadKPIs() {
      const r = await postJSON(API.metrics, { initData: INITDATA });
      $("#kpiUsers").textContent = r.users ?? "—";
      $("#kpiBal").textContent = typeof r.total_balance === "number" ? r.total_balance.toFixed(2) : "—";
      if (r.open_draw) {
        $("#kpiDraw").textContent = r.open_draw.code;
        $("#kpiDrawMeta").textContent = `Group ${r.open_draw.group} • scheduled ${new Date(r.open_draw.scheduled_at).toLocaleString()}`;
        // default group selector on overview to the open draw’s group
        $("#ovGroup").value = r.open_draw.group || "A";
      } else {
        $("#kpiDraw").textContent = "—";
        $("#kpiDrawMeta").textContent = "No open draw";
      }
      // Withdraw KPIs
      const wdPending = Number(r.withdraw_pending_count || 0);
      const wdApprovedToday = Number(r.withdraw_approved_today_sum || 0);
      $("#k-wd-pending").textContent = String(wdPending);
      $("#k-wd-approved").textContent = wdApprovedToday.toFixed(2);
    }

    // Quick-jump to Withdraws tab filtered to "pending"
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnGoPendingWds');
      if (btn) btn.addEventListener('click', () => {
        setTab('withdraws');
        const sel = document.getElementById('wdStatus');
        if (sel) sel.value = 'pending';
        if (typeof loadWithdraws === 'function') loadWithdraws(true);
      });
    });

    // ---------- Live Board (Overview) ----------
    let sse = null;
    function renderBoard(totals=[]) {
      const g = $("#boardGrid"); g.innerHTML = "";
      for (let i=1; i<=36; i++) {
        const v = totals[i-1] ?? 0;
        const d = document.createElement("div");
        d.className = "cell";
        d.innerHTML = `<div class="muted" style="font-size:12px">${i}</div><div style="font-weight:700">${v}</div>`;
        g.appendChild(d);
      }
    }
    async function loadBoardSnapshot(group) {
      const res = await fetch(`${API.board}?group=${encodeURIComponent(group)}`);
      const json = await res.json();
      if (json.ok) {
        $("#ovBoardMeta").textContent = `Draw ${json.draw?.code || "—"} • Total ${json.grand_total}`;
        renderBoard(json.groups?.[group] || json.totals || []);
      }
    }
    function connectSSE(group) {
      if (sse) { sse.close(); sse = null; }
      sse = new EventSource(`${API.sse}?group=${encodeURIComponent(group)}`);
      sse.addEventListener("connected", ev => {
        try { const p = JSON.parse(ev.data); $("#ovBoardMeta").textContent = `Connected • group ${p.group}` } catch {}
      });
      sse.addEventListener("board", ev => {
        try {
          const p = JSON.parse(ev.data);
          $("#ovBoardMeta").textContent = `Draw ${p.draw?.code || "—"} • Total ${p.grand_total}`;
          renderBoard(p.totals || []);
          $("#boardWrap").classList.add("pulse");
          setTimeout(()=>$("#boardWrap").classList.remove("pulse"), 400);
        } catch {}
      });
      sse.addEventListener("error", ev => { /* passive */ });
    }

    // ---------- Draws controls ----------
    async function loadCurrentOpenForDraws() {
      const res = await fetch(API.openDraw);
      const j = await res.json();
      if (j.ok && j.open) {
        $("#drawNow").textContent = j.open.code;
        $("#drawNowMeta").textContent = `Group ${j.open.group} • scheduled ${new Date(j.open.scheduled_at).toLocaleString()}`;
        $("#ctlGroup").value = j.open.group || "A";
      } else {
        $("#drawNow").textContent = "—";
        $("#drawNowMeta").textContent = "No open draw";
      }
    }
    async function callExec(action) {
      const group = $("#ctlGroup").value;
      const force = Number($("#ctlForce").value || "");
      const body = { initData: INITDATA, action, group };
      if (!Number.isNaN(force) && force>=1 && force<=36) body.force = force;

      const res = await fetch(API.exec, {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          "x-cron-key": CRON_KEY
        },
        body: JSON.stringify(body)
      });
      const txt = await res.text(); let data = null; try { data = JSON.parse(txt) } catch { data = { raw: txt } }
      $("#ctlResult").textContent = JSON.stringify(data, null, 2);
      if (!res.ok) { toast(`Exec ${action} failed`, "bad"); return; }
      toast(`Exec ${action} OK`, "ok");
      // refresh
      await loadKPIs(); await loadCurrentOpenForDraws();
    }

    $("#btnCloseNow").addEventListener("click", ()=>callExec("close"));
    $("#btnExecuteNow").addEventListener("click", ()=>callExec("execute"));
    $("#btnSeedNext").addEventListener("click", ()=>callExec("seed"));

    // ---------- Transactions ----------
    let TXN_OFFSET = 0, TXN_LIMIT = 50, TXN_LAST = [];
    function renderTxns(rows, append=false) {
      const tb = $("#txTable tbody");
      if (!append) tb.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        const ts = r.created_at ? MYT.format(new Date(r.created_at)) : "—";
        tr.innerHTML = `
          <td>${ts}</td>
          <td class="mono">${r.user_mask || r.user_id || "—"}</td>
          <td>${r.type}</td>
          <td class="right">${Number(r.amount).toFixed(2)}</td>
          <td class="right">${Number(r.balance_after).toFixed(2)}</td>
          <td class="mono">${(r.note||"")}</td>
        `;
        tb.appendChild(tr);
      }
    }
    function filterTxns(rows) {
      const t = $("#fType").value.trim().toLowerCase();
      const q = $("#fText").value.trim().toLowerCase();
      return rows.filter(r => {
        const typeOk = !t || (r.type||"").toLowerCase()===t;
        const txt = `${r.note||""} ${r.user_mask||""} ${r.user_id||""}`.toLowerCase();
        const textOk = !q || txt.includes(q);
        return typeOk && textOk;
      });
    }
    async function loadTxns(reset=true) {
      if (reset) { TXN_OFFSET = 0; TXN_LAST = []; }
      const r = await postJSON(API.txns, { initData: INITDATA, offset: TXN_OFFSET, limit: TXN_LIMIT });
      TXN_LAST = r.txns || [];
      const view = filterTxns(TXN_LAST);
      renderTxns(view, !reset);
      $("#txnsHint").textContent = `Fetched ${TXN_LAST.length} (server page). Use filters to refine.`;
      TXN_OFFSET += TXN_LIMIT;
    }
    $("#btnReloadTxns").addEventListener("click", ()=>loadTxns(true));
    $("#btnMoreTxns").addEventListener("click", ()=>loadTxns(false));
    $("#fType").addEventListener("change", ()=>renderTxns(filterTxns(TXN_LAST), false));
    $("#fText").addEventListener("input", ()=>renderTxns(filterTxns(TXN_LAST), false));

    // ---------- Withdraws (list) ----------
    let WD_OFFSET = 0, WD_LIMIT = 50, WD_LAST = [];
    function renderWithdraws(rows, append=false) {
      const tb = $("#wdTable tbody");
      if (!append) tb.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        const ts = r.created_at ? MYT.format(new Date(r.created_at)) : "—";
        const pending = String(r.status||'pending') === 'pending';
        tr.innerHTML = `
          <td>${ts}</td>
          <td class="mono">${r.user_mask || r.user_id || "—"}</td>
          <td class="right">${Number(r.amount||0).toFixed(2)}</td>
          <td class="mono">${r.note ? String(r.note) : ""}</td>
          <td>${String(r.status||'pending')}</td>
          <td>
            ${pending ? `
              <button data-wd="approve" data-id="${r.id}" class="primary">Approve</button>
              <button data-wd="reject" data-id="${r.id}" class="error" style="margin-left:6px;">Reject</button>
            ` : `<span class="muted">—</span>`}
          </td>
        `;
        tb.appendChild(tr);
      }
    }
    async function actWithdraw(id, action) {
      try {
        const btns = [...document.querySelectorAll(`button[data-id="${id}"]`)];
        btns.forEach(b => { b.disabled = true; b.textContent = (action==='approve'?'Approving…':'Rejecting…'); });
        const res = await postJSON(API.withdrawUpdate, { initData: INITDATA, id, action });
        if (res?.ok) {
          toast(`Withdraw ${action}d`, 'ok');
          await loadWithdraws(true);
          // keep Overview KPIs in sync
          if (typeof loadKPIs === 'function') await loadKPIs();
        } else {
          const msg = res?.error || 'Update failed';
          toast(`${msg}${res?.rid?` [rid=${res.rid}]`:''}`, 'bad');
          btns.forEach(b => { b.disabled = false; b.textContent = b.dataset.wd === 'approve' ? 'Approve' : 'Reject'; });
        }
      } catch (e) {
        toast('Network error', 'bad');
        const btns = [...document.querySelectorAll(`button[data-id="${id}"]`)];
        btns.forEach(b => { b.disabled = false; b.textContent = b.dataset.wd === 'approve' ? 'Approve' : 'Reject'; });
      }
    }
    // Delegate clicks for approve/reject
    $("#wdTable tbody").addEventListener("click", (ev) => {
      const btn = ev.target.closest('button[data-wd]');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.wd;
      if (!id || !action) return;
      actWithdraw(id, action);
    });
    async function loadWithdraws(reset=true) {
      if (reset) { WD_OFFSET = 0; WD_LAST = []; }
      const status = $("#wdStatus").value || "pending";
      const r = await postJSON(API.withdraws, { initData: INITDATA, status, limit: WD_LIMIT, offset: WD_OFFSET });
      const rows = Array.isArray(r.rows) ? r.rows : [];
      WD_LAST = rows;
      renderWithdraws(rows, !reset);
      $("#wdsHint").textContent = `Fetched ${rows.length} (server page) • status=${status || 'any'}`;
      WD_OFFSET += WD_LIMIT;
    }
    $("#btnReloadWds").addEventListener("click", ()=>loadWithdraws(true));
    $("#btnMoreWds").addEventListener("click", ()=>loadWithdraws(false));
    $("#wdStatus").addEventListener("change", ()=>loadWithdraws(true));

// [REMOVED DUPLICATE Deposits BLOCK]
// ---------- Reports ----------
async function loadReport() {
  const out = $("#repOutput");
  out.textContent = 'Loading…';
  try {
    const table = $("#repTable").value;
    const r = await postJSON("/api/admin", { action:"reports", table, limit:50 });
    if (!r.ok) { out.textContent = 'Error loading report'; return; }
    const rows = r.rows || [];
    if (rows.length === 0) { out.textContent = 'No records'; return; }
    let html = "<table><thead><tr>";
    Object.keys(rows[0]).forEach(col => { html += `<th>${col}</th>`; });
    html += "</tr></thead><tbody>";
    rows.forEach(row => {
      html += "<tr>";
      Object.values(row).forEach(v => { html += `<td>${v}</td>`; });
      html += "</tr>";
    });
    html += "</tbody></table>";
    out.innerHTML = html;
  } catch (e) {
    out.textContent = 'Error loading report';
    toast('Failed to load report', 'bad');
  }
}
$("#btnLoadReport").addEventListener("click", loadReport);

// [REMOVED DUPLICATE approveDeposit and event listeners]
    
// ---------- Deposits ----------
let DEP_OFFSET = 0, DEP_LIMIT = 50;
async function loadDeposits(reset=true) {
  try {
    if (reset) DEP_OFFSET = 0;
    // show loading row
    setTableLoading('#depTable tbody', 'Loading deposits…');
    const status = $("#depStatus").value || "pending";
    const r = await postJSON("/api/admin", { action:"list_deposits", status, limit:DEP_LIMIT, offset:DEP_OFFSET });
    const rows = Array.isArray(r.deposits) ? r.deposits : [];

    const tb = $("#depTable tbody");
    tb.innerHTML = "";
    if (rows.length === 0) {
      setTableEmpty('#depTable tbody', `No ${status || 'recent'} deposits`);
    } else {
      rows.forEach(d => {
        const ts = d.created_at ? MYT.format(new Date(d.created_at)) : "—";
        const pending = d.status === "pending";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ts}</td>
          <td class="mono">${d.user_mask||d.user_id}</td>
          <td class="right">${Number(d.amount||0).toFixed(2)}</td>
          <td class="mono">${d.note||""}</td>
          <td>${d.status}</td>
          <td>${pending ? `<button class="primary" onclick="approveDeposit('${d.id}')">Approve</button>` : "—"}</td>
        `;
        tb.appendChild(tr);
      });
    }
    DEP_OFFSET += DEP_LIMIT;
    $("#depsHint").textContent = `Fetched ${rows.length} (server page) • status=${status}`;
  } catch (e) {
    toast('Failed to load deposits', 'bad');
    setTableEmpty('#depTable tbody', 'Error loading deposits');
  }
}
async function approveDeposit(id) {
  const r = await postJSON("/api/admin", { action:"approve_deposit", requestId:id });
  toast(r.ok ? "Deposit approved" : "Failed", r.ok?"ok":"bad");
  await loadDeposits(true);
}
$("#btnReloadDeps").addEventListener("click", ()=>loadDeposits(true));
$("#btnMoreDeps").addEventListener("click", ()=>loadDeposits(false));
$("#depStatus").addEventListener("change", ()=>loadDeposits(true));

// ---------- Bootstrap ----------
    async function boot() {
      setRID();
      await ensureAdmin();
      await loadKPIs();

      // overview live board
      const g = $("#ovGroup").value;
      await loadBoardSnapshot(g);
      connectSSE(g);
      $("#ovGroup").addEventListener("change", async (e) => {
        const gg = e.target.value;
        await loadBoardSnapshot(gg);
        connectSSE(gg);
      });

      // draws & txns
      await loadCurrentOpenForDraws();
      await loadTxns(true);
      await loadWithdraws(true);
    }
    boot();
  </script>

  <div class="tag" style="margin:12px 20px; font-size:12px; opacity:.7">
    v: admin-07 · bot: <script>document.write(window.tgBot?.botUsername || 'Unknown')</script>
  </div>

  </div>


  <script>
    // Ensure Telegram WebApp uses full height (safety net like bet.html)
    (function() {
      function expandIfReady() {
        try {
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
          }
        } catch (e) {}
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', expandIfReady);
      } else {
        expandIfReady();
      }
    })();
  </script>
</script>
<script type="module">
  import { go } from '/web/_nav.js';
  document.querySelectorAll('[data-link]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      go(a.getAttribute('data-link'));
    });
  });
</script>
<script type="module">
  import { requireTelegramBanner } from '/web/_guard.js';
  requireTelegramBanner();
</script>
<script type="module">
// User Management Enhancer — converts numeric search to text, removes overlays, wires search → backend
(function(){
  // Remove any dim/overlay elements commonly used by that layout
  document.querySelectorAll('.overlay, #overlay, [data-overlay], .backdrop, .dim-bg').forEach(el => {
    try { el.remove(); } catch {}
  });

  // Find a likely search input by id/name and coerce it to a text box
  const input = document.querySelector('#userSearch, input[name="userSearch"], input[data-role="user-search"]');
  if (input) {
    if (input.type !== 'text') {
      input.setAttribute('type','text');
      input.removeAttribute('inputmode');
      input.removeAttribute('pattern');
    }
    if (!input.placeholder) input.placeholder = 'Search user by ID, username, or name';

    // Render helper for a generic results table if present
    function renderUsers(users){
      const tb = document.querySelector('#usersTable tbody, table[data-users] tbody');
      if (!tb) return;
      tb.innerHTML = '';
      (users||[]).forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${u.id ?? u.user_id ?? ''}</td>
          <td>${u.name ?? u.username ?? ''}</td>
          <td class="mono">${u.contact ?? ''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    // Debounced fetch to backend admin users search
    let t = null;
    const onChange = () => {
      clearTimeout(t);
      t = setTimeout(async () => {
        try {
          const q = input.value.trim();
          const res = await postJSON('/api/admin', { action: 'users', query: q });
          if (res && res.ok !== false) renderUsers(res.users || res.rows || []);
        } catch (e) { /* silent */ }
      }, 250);
    };

    input.addEventListener('input', onChange);
    input.addEventListener('change', onChange);
  }
})();
</script>
</body>
</html>
